<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dr.mapper.myPage.MyPageMapper">
    <!--  자기 자신 정보 확인(내정보) -->
    <select id="getUserInfo" parameterType="Long" resultType="UserInfoDTO">
        SELECT
            U.USER_NICKNAME AS USER_NICKNAME,
            U.USER_EMAIL AS USER_EMAIL,
            U.USER_PHONE AS USER_PHONE,
            NVL(S.ENVIRONMENT_SCORE, 0) AS ENVIRONMENT_SCORE,
            NVL(R.ENVIRONMENT_RANK, 0) AS ENVIRONMENT_RANK,
            NVL(P.TOTAL_POINTS, 0) AS TOTAL_POINTS,
            COALESCE(PH.PHOTO_ORIGINAL, '기본프사.JPG') AS PHOTO
        FROM
            DR_USER U
                LEFT JOIN
            (SELECT
                 USER_NUMBER,
                 SUM(SCORE_GET) AS ENVIRONMENT_SCORE
             FROM
                 DR_SCORE
             GROUP BY USER_NUMBER) S ON U.USER_NUMBER = S.USER_NUMBER
                LEFT JOIN
            (SELECT
                 USER_NUMBER,
                 DENSE_RANK() OVER (ORDER BY SUM(SCORE_GET) DESC) AS ENVIRONMENT_RANK
             FROM
                 DR_SCORE
             GROUP BY USER_NUMBER) R ON U.USER_NUMBER = R.USER_NUMBER
                LEFT JOIN
            (SELECT
                 USER_NUMBER,
                 SUM(POINT_GET - POINT_USE) AS TOTAL_POINTS
             FROM
                 DR_POINT
             GROUP BY USER_NUMBER) P ON U.USER_NUMBER = P.USER_NUMBER
                LEFT JOIN
            (SELECT
                 USER_NUMBER,
                 PHOTO_ORIGINAL
             FROM
                 (SELECT
                      USER_NUMBER,
                      PHOTO_ORIGINAL,
                      ROW_NUMBER() OVER (PARTITION BY USER_NUMBER ORDER BY CASE WHEN PHOTO_ORIGINAL = '유저등록사진.JPG' THEN 1 ELSE 2 END) AS RN
                  FROM
                      DR_PHOTO
                  WHERE
                      PHOTO_ORIGINAL IN ('유저등록사진.JPG', '기본프사.JPG')
                 )
             WHERE RN = 1) PH ON U.USER_NUMBER = PH.USER_NUMBER
        WHERE
            U.USER_NUMBER = #{userNumber}
    </select>

    <!--  회원 탈퇴 -->
    <delete id="deleteUser" parameterType="Long">
        DELETE FROM DR_USER
        WHERE USER_NUMBER = #{userNumber}
    </delete>

    <!--  내정보 포인트 내역 확인 -->
    <select id="pointHistory" parameterType="Long" resultType="PointDetailDTO">
        <![CDATA[
        SELECT DP.POINT_NUMBER, DP.POINT_NOTE,
        CASE WHEN DP.POINT_NOTE IN ('관리자회수', '상품구매') THEN -DP.POINT_USE
        ELSE DP.POINT_GET END AS pointGet,
        DP.POINT_DATE AS pointDate,
        COALESCE((SELECT SUM(
        CASE
        WHEN DP2.POINT_NOTE IN ('신규가입', '출석체크', '랭킹', '개근') THEN DP2.POINT_GET
        WHEN DP2.POINT_NOTE IN ('관리자회수', '상품구매') THEN -DP2.POINT_USE
        ELSE 0
        END)
        FROM DR_POINT DP2
        WHERE DP2.USER_NUMBER = DP.USER_NUMBER
        AND DP2.POINT_DATE <= DP.POINT_DATE), 0) AS totalPoints
        FROM DR_POINT DP
        WHERE DP.USER_NUMBER = #{userNumber}
        ORDER BY DP.POINT_DATE DESC
        ]]>
    </select>

    <!--  내정보 내가 쓴 레시피 목록 -->
    <select id="getUserRecipe" parameterType="Long" resultType="UserRecipeDTO">
        SELECT
            P.RECIPE_PHOTO,
            R.RECIPE_TITLE,
            TO_CHAR(R.RECIPE_WRITE_DATE, 'YYYY-MM-DD') AS RECIPE_WRITE_DATE, -- 날짜 형식 변환
            (SELECT COUNT(*)
             FROM DR_GOOD G
             WHERE G.RECIPE_NUMBER = R.RECIPE_NUMBER) AS GOOD_COUNT
        FROM
            DR_RECIPE R
                LEFT JOIN (
                SELECT
                    PHOTO_LOCAL AS RECIPE_PHOTO,
                    RECIPE_NUMBER,
                    ROW_NUMBER() OVER (PARTITION BY RECIPE_NUMBER ORDER BY PHOTO_NUMBER) AS RN
                FROM
                    DR_PHOTO
            ) P ON R.RECIPE_NUMBER = P.RECIPE_NUMBER AND P.RN = 1
        WHERE
            R.USER_NUMBER = #{userNumber}
        ORDER BY
            R.RECIPE_WRITE_DATE DESC
    </select>
</mapper>